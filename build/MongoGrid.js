var _this=this;var GridStore=require("mongodb").GridStore;var ObjectId=require("mongodb").ObjectID;var upload=function upload(files,db){return uploadFiles(files,db);};var download=function download(fileKey,db){fileKey=new ObjectId(fileKey);return downloadFile(fileKey,db);};var downloadFile=function downloadFile(fileKey,db){if(!fileKey){throw new Error("fileKey not found ");}return new Promise(function(resolve,reject){var gridStore=new GridStore(db,fileKey,"r");gridStore.open(function(err){if(err){reject(err);return;}gridStore.seek(0,0,function(err){if(err){reject(err);return;}gridStore.read(function(err,data){if(err){reject(err);return;}resolve({fileName:gridStore.filename,contentType:gridStore.contentType,data:data});});});});});};var downloadFileStream=function downloadFileStream(fileKey,db){if(!fileKey){throw new Error("fileKey not found ");}fileKey=new ObjectId(fileKey);return new Promise(function(resolve,reject){var gridStore=new GridStore(db,fileKey,"r");gridStore.open(function(err,gs){var stream=gs.stream();var data=[];var bodylength=0;stream.on("data",function(chunk){data.push(chunk);bodylength+=chunk.length;});stream.on("end",function(){resolve({fileName:gridStore.filename,contentType:gridStore.contentType,data:data});});});});};var uploadFiles=function uploadFiles(files,db){var isArray,fileKeys,_iterator,_isArray,_i,_ref,file,fileKey,filename,data,type;return regeneratorRuntime.async(function uploadFiles$(_context){while(1){switch(_context.prev=_context.next){case 0:isArray=true;if(!Array.isArray(files)){files=[files];isArray=false;}fileKeys=[];_iterator=files,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();case 4:if(!_isArray){_context.next=10;break;}if(!(_i>=_iterator.length)){_context.next=7;break;}return _context.abrupt("break",22);case 7:_ref=_iterator[_i++];_context.next=14;break;case 10:_i=_iterator.next();if(!_i.done){_context.next=13;break;}return _context.abrupt("break",22);case 13:_ref=_i.value;case 14:file=_ref;fileKey=file.fileKey,filename=file.filename,data=file.data,type=file.type;fileKey=fileKey?new ObjectId(fileKey):new ObjectId();_context.next=19;return regeneratorRuntime.awrap(uploadFileInMongo(filename,fileKey,data,type,db));case 19:fileKeys.push({key:fileKey.toString(),name:filename});case 20:_context.next=4;break;case 22:return _context.abrupt("return",isArray?fileKeys:fileKeys[0]);case 23:case"end":return _context.stop();}}},null,_this);};var uploadFileInMongo=function uploadFileInMongo(fileName,fileKey,data,content_type,db){return regeneratorRuntime.async(function uploadFileInMongo$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return regeneratorRuntime.awrap(new Promise(function(resolve,reject){var gridStore=new GridStore(db,fileKey,fileName,"w",{content_type:content_type});gridStore.open(function _callee(err){var i;return regeneratorRuntime.async(function _callee$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;if(!err){_context2.next=4;break;}reject(err);return _context2.abrupt("return");case 4:i=0;case 5:if(!(i<data.length)){_context2.next=11;break;}_context2.next=8;return regeneratorRuntime.awrap(writeInGridStore(gridStore,data[i]));case 8:i++;_context2.next=5;break;case 11:gridStore.close(function(err){if(err){reject(err);return;}resolve();});_context2.next=17;break;case 14:_context2.prev=14;_context2.t0=_context2["catch"](0);reject(_context2.t0);case 17:case"end":return _context2.stop();}}},null,_this,[[0,14]]);});}));case 2:case"end":return _context3.stop();}}},null,_this);};function writeInGridStore(gridStore,buffer){return new Promise(function(res,rej){gridStore.write(buffer,function(err,result){if(err){rej(err);}else{res(result);}});});}module.exports={upload:upload,download:download,downloadFileStream:downloadFileStream};