var _this=this;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _MongoConnect=require("./MongoConnect");var _MongoConnect2=_interopRequireDefault(_MongoConnect);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var ObjectId=require("mongodb").ObjectID;var config={host:"192.168.100.194",port:28853,dbName:"productivity_testing",fileDBName:"files_db",logDBName:"app_v3_logs"};var mongoConnect=new _MongoConnect2.default({config:config});var updateLogs=function updateLogs(result){var index,d,deliveriesResult,_result,res,preOrder,deliveries,children,orderdate,orderNew,_orderNew,index1,orderid,delivery;return regeneratorRuntime.async(function updateLogs$(_context){while(1){switch(_context.prev=_context.next){case 0:index=0;case 1:if(!(index<result.length)){_context.next=44;break;}d=result[index];_context.next=5;return regeneratorRuntime.awrap(mongoConnect.mAggregate("Deliveries",[{$match:{delivery_date:{$exists:true},"order_id._id":d._id}},{$project:{year:{$year:"$delivery_date"},month:{$month:"$delivery_date"},day:{$dayOfMonth:"$delivery_date"},amount:"$amount",base_amount:"$base_amount",delivery_date:"$delivery_date"}},{$group:{_id:{year:"$year",month:"$month",day:"$day"},amount:{$sum:"$amount"},base_amount:{$sum:"$base_amount"},delivery_date:{$first:"$delivery_date"},child:{$push:{_id:"$_id"}}}}]));case 5:deliveriesResult=_context.sent;if(!(deliveriesResult.result&&deliveriesResult.result.length>0)){_context.next=41;break;}_result=deliveriesResult.result;res=0;case 9:if(!(res<_result.length)){_context.next=41;break;}preOrder=_extends({},d);deliveries=_result[res];children=deliveries.child||[];delete preOrder._id;orderdate=JSON.parse(JSON.stringify(preOrder.order_date));preOrder.order_date=deliveries.delivery_date;preOrder.amount=deliveries.amount;preOrder.base_amount=deliveries.base_amount;preOrder.order_number=d.order_number+"-"+res+1;if(!(preOrder.order_date&&deliveries.delivery_date)){_context.next=38;break;}if(!compareTwoDatesEquals(new Date(orderdate),new Date(deliveries.delivery_date))){_context.next=26;break;}_context.next=23;return regeneratorRuntime.awrap(mongoConnect.update("Orders",{_id:d._id},{$set:{amount:deliveries.amount,base_amount:deliveries.base_amount}}));case 23:orderNew=_context.sent;_context.next=38;break;case 26:_context.next=28;return regeneratorRuntime.awrap(mongoConnect.insert("Orders",preOrder));case 28:_orderNew=_context.sent;index1=0;case 30:if(!(index1<children.length)){_context.next=38;break;}orderid=_orderNew.result._id;_context.next=34;return regeneratorRuntime.awrap(mongoConnect.update("Deliveries",{_id:children[index1]._id},{$set:{order_id:{_id:orderid},oldorder:{_id:d._id}}}));case 34:delivery=_context.sent;case 35:index1++;_context.next=30;break;case 38:res++;_context.next=9;break;case 41:index++;_context.next=1;break;case 44:case"end":return _context.stop();}}},null,_this);};try{mongoConnect.find("Orders",{filter:{_id:{$exists:true}}}).then(function(result){result=result.result;return updateLogs(result);}).catch(function(e){console.log("error>>>",e);});}catch(e){console.log("error>>>",e);}var compareTwoDatesEquals=function compareTwoDatesEquals(date1,date2){if(date1&&date2){var day1=date1.getUTCDate();var month1=date1.getUTCMonth();var year1=date1.getUTCFullYear();var day2=date2.getUTCDate();var month2=date2.getUTCMonth();var year2=date2.getUTCFullYear();if(Number(day1)==Number(day2)&&Number(month1)==Number(month2)&&Number(year1)==Number(year2)){return true;}else{return false;}}else{return false;}};