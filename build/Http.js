var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _this=this;var _DBConnect=require("./DBConnect");var _Transaction=require("./Transaction");var _Transaction2=_interopRequireDefault(_Transaction);var _formidable=require("formidable");var Formidable=_interopRequireWildcard(_formidable);var _bodyParser=require("body-parser");var _bodyParser2=_interopRequireDefault(_bodyParser);var _cron=require("./cron");var _rhsCommon=require("rhs-common");var _Decryption=require("./decryption/Decryption");var _LogsRequired=require("./LogsRequired");var _ValidateAllowedPath=require("./ValidateAllowedPath");function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var urlParser=require("url");var ObjectID=require("mongodb").ObjectID;var isJSONObject=_rhsCommon.PureFunctions.isJSONObject,deepClone=_rhsCommon.PureFunctions.deepClone;var configure=function configure(app,config){var mailConfig,dbConnect,mongoConnect,fileConnect,resourceConnect,crons,rhsCrons,context,port,s3BucketConfig,uploadFiles,download,invokeS3BucketFunction,currentPath,splittedPath;return regeneratorRuntime.async(function configure$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:mailConfig=config.mailConfig,dbConnect=config.dbConnect,mongoConnect=config.mongoConnect,fileConnect=config.fileConnect,resourceConnect=config.resourceConnect,crons=config.crons,rhsCrons=config.rhsCrons,context=config.context,port=config.port,s3BucketConfig=config.s3BucketConfig;process.on("uncaughtException",function(err){console.log(">>>>uncaughtException>>>>>>>>>>>>",err.stack);});if(!(context&&context.ROLLBACK_TX)){_context12.next=5;break;}_context12.next=5;return regeneratorRuntime.awrap((0,_Transaction._rollbackPendingTxs)(mongoConnect,{port:port,mailConfig:mailConfig,dbConnect:dbConnect,context:context}));case 5:app.use(_bodyParser2.default.json({limit:"50mb"}));app.use(_bodyParser2.default.urlencoded({extended:true,limit:2000*1024}));app.options("*",function(req,res){res.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"access-control-allow-origin, content-type, accept"});res.end();});uploadFiles=function uploadFiles(req,resp,nativeConnect){var _ref,files,token,s3,async,ip,transactionConnect,_dbConnect,user,mongoResult;return regeneratorRuntime.async(function uploadFiles$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return regeneratorRuntime.awrap(readFiles(req));case 3:_ref=_context.sent;files=_ref.files;token=_ref.token;s3=_ref.s3;async=_ref.async;if(token){_context.next=10;break;}throw new Error("Token is mandatory to upload");case 10:ip=getIp(req);transactionConnect=new _Transaction2.default(mongoConnect,void 0,{port:port,mailConfig:mailConfig,context:context});_dbConnect=(0,_DBConnect.DbConnect)(transactionConnect);_context.next=15;return regeneratorRuntime.awrap(authenticateUser(token,{_dbConnect:_dbConnect,req:getRequestInfo(req)}));case 15:user=_context.sent;if(!(s3&&s3BucketConfig)){_context.next=23;break;}_context.next=19;return regeneratorRuntime.awrap(invokeS3BucketFunction("upload",{files:files,user:user,s3:s3,async:async}));case 19:mongoResult=_context.sent;mongoResult=mongoResult.result;_context.next=26;break;case 23:_context.next=25;return regeneratorRuntime.awrap(nativeConnect.upload(files));case 25:mongoResult=_context.sent;case 26:_context.next=28;return regeneratorRuntime.awrap(writeJSONResponse(mongoResult,req,resp));case 28:_context.next=34;break;case 30:_context.prev=30;_context.t0=_context["catch"](0);_context.next=34;return regeneratorRuntime.awrap(writeJSONResponse(_context.t0,req,resp));case 34:case"end":return _context.stop();}}},null,_this,[[0,30]]);};download=function download(req,resp,s3){var _getRequestParams,fileKey,name,download,inline,token,others,ip,transactionConnect,_dbConnect2,user,_ref2,data,fileName,contentType,_ref3,options,head;return regeneratorRuntime.async(function download$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_getRequestParams=getRequestParams(req),fileKey=_getRequestParams.fileKey,name=_getRequestParams.fileName,download=_getRequestParams.download,inline=_getRequestParams.inline,token=_getRequestParams.token,others=_getRequestParams.others;if(token){_context2.next=4;break;}throw new Error("Token is mandatory to download");case 4:name=name&&decodeURIComponent(name);ip=getIp(req);transactionConnect=new _Transaction2.default(mongoConnect,void 0,{port:port,mailConfig:mailConfig,context:context});_dbConnect2=(0,_DBConnect.DbConnect)(transactionConnect);_context2.next=10;return regeneratorRuntime.awrap(authenticateUser(token,{_dbConnect:_dbConnect2,req:getRequestInfo(req)}));case 10:user=_context2.sent;if(!(s3&&s3BucketConfig)){_context2.next=20;break;}_context2.next=14;return regeneratorRuntime.awrap(invokeS3BucketFunction("download",{user:user,fileKey:fileKey,name:name,others:others}));case 14:_ref2=_context2.sent;data=_ref2.data;fileName=_ref2.fileName;contentType=_ref2.contentType;_context2.next=26;break;case 20:_context2.next=22;return regeneratorRuntime.awrap(fileConnect.download(fileKey));case 22:_ref3=_context2.sent;data=_ref3.data;fileName=_ref3.fileName;contentType=_ref3.contentType;case 26:if(!(name&&name!==fileName)){_context2.next=28;break;}throw new Error("Name not matched.");case 28:options={ignoreGzip:true,ignoreWrap:true};if(download||inline){head={};head["Content-Disposition"]=(download?"attachment":"inline")+'; filename="'+fileName+'"';head["Content-Type"]=getContentType(fileName)||contentType;options["head"]=head;}_context2.next=32;return regeneratorRuntime.awrap(writeJSONResponse(data,req,resp,options));case 32:_context2.next=38;break;case 34:_context2.prev=34;_context2.t0=_context2["catch"](0);_context2.next=38;return regeneratorRuntime.awrap(writeJSONResponse(_context2.t0,req,resp));case 38:case"end":return _context2.stop();}}},null,_this,[[0,34]]);};invokeS3BucketFunction=function invokeS3BucketFunction(id,params){var functions,credentials;return regeneratorRuntime.async(function invokeS3BucketFunction$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:functions=s3BucketConfig.functions,credentials=s3BucketConfig.credentials;if(!(!credentials||!functions)){_context3.next=3;break;}throw new Error("S3 Bucket credentials & functions are mandatory");case 3:_context3.next=5;return regeneratorRuntime.awrap(dbConnect((0,_DBConnect.invoke)(functions[id],_extends({credentials:credentials},params))));case 5:return _context3.abrupt("return",_context3.sent);case 6:case"end":return _context3.stop();}}},null,_this);};app.all("/upload",function _callee(req,resp){return regeneratorRuntime.async(function _callee$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return regeneratorRuntime.awrap(uploadFiles(req,resp,fileConnect));case 2:return _context4.abrupt("return",_context4.sent);case 3:case"end":return _context4.stop();}}},null,_this);});app.all("/uploadResource",function _callee2(req,resp){return regeneratorRuntime.async(function _callee2$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return regeneratorRuntime.awrap(uploadFiles(req,resp,resourceConnect));case 2:return _context5.abrupt("return",_context5.sent);case 3:case"end":return _context5.stop();}}},null,_this);});app.all("/download/s3",function _callee3(req,resp){return regeneratorRuntime.async(function _callee3$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return regeneratorRuntime.awrap(download(req,resp,true));case 2:return _context6.abrupt("return",_context6.sent);case 3:case"end":return _context6.stop();}}},null,_this);});app.all("/download",function _callee4(req,resp){return regeneratorRuntime.async(function _callee4$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return regeneratorRuntime.awrap(download(req,resp));case 2:return _context7.abrupt("return",_context7.sent);case 3:case"end":return _context7.stop();}}},null,_this);});app.all("/resource/*",function _callee5(req,resp){var params,fileDetail,fileInfo,fileKey,name,_ref4,data,fileName,contentType,options,head;return regeneratorRuntime.async(function _callee5$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;params=req.params||{};fileDetail=params&&params["0"];if(fileDetail){_context8.next=5;break;}throw new Error("Something is missing.");case 5:fileInfo=fileDetail.split("/");fileKey=fileInfo[0];name=fileInfo.length>1?fileInfo[1]:void 0;_context8.next=10;return regeneratorRuntime.awrap(resourceConnect.download(fileKey));case 10:_ref4=_context8.sent;data=_ref4.data;fileName=_ref4.fileName;contentType=_ref4.contentType;if(!(name&&name!==fileName)){_context8.next=16;break;}throw new Error("Name not matched.");case 16:options={ignoreGzip:true,ignoreWrap:true};head={};head["Content-Disposition"]="inline"+'; filename="'+fileName+'"';head["Content-Type"]=getContentType(fileName)||contentType;options["head"]=head;_context8.next=23;return regeneratorRuntime.awrap(writeJSONResponse(data,req,resp,options));case 23:_context8.next=29;break;case 25:_context8.prev=25;_context8.t0=_context8["catch"](0);_context8.next=29;return regeneratorRuntime.awrap(writeJSONResponse(_context8.t0,req,resp));case 29:case"end":return _context8.stop();}}},null,_this,[[0,25]]);});app.all("/runningStatus",function _callee6(req,resp){var runningStatus;return regeneratorRuntime.async(function _callee6$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:runningStatus="Server running";_context9.next=3;return regeneratorRuntime.awrap(writeJSONResponse(runningStatus,req,resp));case 3:case"end":return _context9.stop();}}},null,_this);});app.all("/profiling",function _callee7(req,resp){var systemProfiler,profileLogs;return regeneratorRuntime.async(function _callee7$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:systemProfiler=config.systemProfiler;profileLogs=systemProfiler?systemProfiler.getLogs():{result:{message:"Profiling is disabled"}};_context10.next=4;return regeneratorRuntime.awrap(writeJSONResponse(profileLogs,req,resp));case 4:case"end":return _context10.stop();}}},null,_this);});app.all("/invoke",function _callee8(req,resp){var reqParams,reqInfo,result,_parseResponseHeader,data,options;return regeneratorRuntime.async(function _callee8$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.prev=0;reqParams=getRequestParams(req,true);reqInfo=getRequestInfo(req);_context11.next=5;return regeneratorRuntime.awrap(_invoke(reqParams,reqInfo,config));case 5:result=_context11.sent;_parseResponseHeader=parseResponseHeader(result),data=_parseResponseHeader.data,options=_parseResponseHeader.options;if(options&&options._cookies&&options._cookies.token&&options._cookies.domain){resp.cookie("token",options._cookies.token,{domain:options._cookies.domain,maxAge:9000000});}_context11.next=10;return regeneratorRuntime.awrap(writeJSONResponse(data,req,resp,options));case 10:_context11.next=16;break;case 12:_context11.prev=12;_context11.t0=_context11["catch"](0);_context11.next=16;return regeneratorRuntime.awrap(writeJSONResponse(_context11.t0,req,resp));case 16:case"end":return _context11.stop();}}},null,_this,[[0,12]]);});if(!context.CRON_SERVER){_context12.next=25;break;}currentPath=__dirname;splittedPath=currentPath.split("node_modules")[0];if((0,_ValidateAllowedPath.checkPath)("cron",splittedPath)){_context12.next=24;break;}throw new Error("Cron is not allowed to run from "+currentPath);case 24:return _context12.abrupt("return",(0,_cron.runCron)({db:mongoConnect,crons:_extends({},crons,rhsCrons),dbConnect:dbConnect,port:port,mailConfig:mailConfig,context:context,config:config}));case 25:case"end":return _context12.stop();}}},null,_this);};var getRequestInfo=function getRequestInfo(req){if(!req){return{};}return{ip:getIp(req),host:req.get("host")||req.headers["host"],origin:req.get("origin")||req.headers["origin"]};};var isServiceLogEnabled=function isServiceLogEnabled(context){var enableServiceLogs=true;if(context&&context.MODE){enableServiceLogs=context.MODE==="dev"?false:true;}return enableServiceLogs;};var _invoke=function _invoke(params,reqInfo,config){var logs,logger,user,endHttpRequestLogging,_ref5,logConnectNative,mongoConnect,port,publicServices,loggerConfig,globalCache,context,systemProfiler,mailConfig,skipTxModule,enableServiceLogs,id,token,appVersion,platform,deleteToken,dbConnect,transactionConnect,args,result;return regeneratorRuntime.async(function _invoke$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:logs=void 0,logger=void 0,user=void 0,endHttpRequestLogging=void 0;_ref5=config||{},logConnectNative=_ref5.logConnectNative,mongoConnect=_ref5.mongoConnect,port=_ref5.port,publicServices=_ref5.publicServices,loggerConfig=_ref5.loggerConfig,globalCache=_ref5.globalCache,context=_ref5.context,systemProfiler=_ref5.systemProfiler,mailConfig=_ref5.mailConfig,skipTxModule=_ref5.skipTxModule;enableServiceLogs=isServiceLogEnabled(context);_context13.prev=3;_context13.next=6;return regeneratorRuntime.awrap(modifyInvokeParams(params,config));case 6:id=params.id,token=params.token,appVersion=params.appVersion,platform=params.platform,deleteToken=params.deleteToken;if(id){_context13.next=9;break;}throw new Error("id is mandatory in invoke service");case 9:if(!(!token&&(!publicServices||publicServices.indexOf(id)===-1))){_context13.next=11;break;}throw new Error("token is mandatory in invoke service >>>> "+id);case 11:_context13.next=13;return regeneratorRuntime.awrap(insertServiceLogs(params,reqInfo,config,enableServiceLogs));case 13:logs=_context13.sent;logger=token&&(_LogsRequired.logsRequired[token]||loggerConfig)?new _rhsCommon.Logger({token:token,loggerConfig:loggerConfig}):null;dbConnect=void 0;if(skipTxModule){dbConnect=(0,_DBConnect.DbConnect)(mongoConnect);}else{transactionConnect=new _Transaction2.default(mongoConnect,void 0,{logger:logger,port:port,mailConfig:mailConfig,context:context});dbConnect=(0,_DBConnect.DbConnect)(transactionConnect);}args={_dbConnect:dbConnect,logger:logger,req:reqInfo,globalCache:globalCache,appVersion:appVersion,platform:platform};_context13.next=20;return regeneratorRuntime.awrap(authenticateUser(token,args,id));case 20:user=_context13.sent;endHttpRequestLogging=systemProfiler&&systemProfiler.startHttpRequestLogging({id:id,user:user&&user.email,token:token,paramValue:params&&params.paramValue},{_dbConnect:dbConnect});_context13.next=24;return regeneratorRuntime.awrap(invokeInternal(params,user,args,config));case 24:result=_context13.sent;if(!deleteToken){_context13.next=28;break;}_context13.next=28;return regeneratorRuntime.awrap(mongoConnect.remove("Connection",{token:token,service:id,one_time_use:true}));case 28:updateServiceLogs(logs,user,void 0,{logger:logger,logConnectNative:logConnectNative},enableServiceLogs);endHttpRequestLogging&&endHttpRequestLogging();return _context13.abrupt("return",result);case 33:_context13.prev=33;_context13.t0=_context13["catch"](3);updateServiceLogs(logs,user,_context13.t0,{logger:logger,logConnectNative:logConnectNative},enableServiceLogs);endHttpRequestLogging&&endHttpRequestLogging();throw _context13.t0;case 38:case"end":return _context13.stop();}}},null,_this,[[3,33]]);};var modifyInvokeParams=function modifyInvokeParams(params,config){var id,paramValue,token,invokeData;return regeneratorRuntime.async(function modifyInvokeParams$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:id=params.id,paramValue=params.paramValue,token=params.token;if(!(!id&&!paramValue&&token)){_context14.next=8;break;}_context14.next=4;return regeneratorRuntime.awrap(getServiceByToken(_extends({},params),token,config.mongoConnect));case 4:invokeData=_context14.sent;params.id=invokeData.id;params.paramValue=invokeData.paramValue;params.deleteToken=true;case 8:case"end":return _context14.stop();}}},null,_this);};var invokeInternal=function invokeInternal(params,user,args,config){var dbConnect,id,paramValue,timezoneOffset,globalParamValue,result,mailConfig,developers;return regeneratorRuntime.async(function invokeInternal$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:dbConnect=args._dbConnect;_context15.prev=1;id=params.id,paramValue=params.paramValue,timezoneOffset=params.timezoneOffset,globalParamValue=params.globalParamValue;if(paramValue&&typeof paramValue==="string"){paramValue=JSON.parse(paramValue);}if(globalParamValue&&typeof globalParamValue==="string"&&globalParamValue!=="undefined"){globalParamValue=JSON.parse(globalParamValue);}paramValue=_extends({},paramValue,{user:user});_context15.next=8;return regeneratorRuntime.awrap(dbConnect((0,_DBConnect.invoke)(id,paramValue,_extends({user:user,timezoneOffset:timezoneOffset,globalParamValue:globalParamValue},args))));case 8:result=_context15.sent;_context15.next=11;return regeneratorRuntime.awrap(dbConnect((0,_DBConnect.commit)()));case 11:return _context15.abrupt("return",result);case 14:_context15.prev=14;_context15.t0=_context15["catch"](1);mailConfig=config&&config["mailConfig"];_context15.prev=17;_context15.next=20;return regeneratorRuntime.awrap(dbConnect((0,_DBConnect.rollback)(dbConnect)));case 20:_context15.next=25;break;case 22:_context15.prev=22;_context15.t1=_context15["catch"](17);sendErrorMail(mailConfig&&mailConfig.frameworkDeveloper,_context15.t1,"Rollback Error",dbConnect,params,config);case 25:developers=mailConfig&&mailConfig.applicationDeveloper;sendErrorMail(developers,_context15.t0,"Service Log Error",dbConnect,params,config);throw _context15.t0;case 28:case"end":return _context15.stop();}}},null,_this,[[1,14],[17,22]]);};var insertServiceLogs=function insertServiceLogs(params,reqInfo,args,enableServiceLogs){var logConnectNative,_id,id,paramValue,token,appVersion,platform,logs;return regeneratorRuntime.async(function insertServiceLogs$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:if(enableServiceLogs){_context16.next=2;break;}return _context16.abrupt("return");case 2:logConnectNative=args.logConnectNative;_id=new ObjectID();id=params.id,paramValue=params.paramValue,token=params.token,appVersion=params.appVersion,platform=params.platform;logs={startTime:new Date(),status:"InProgress",token:token,appVersion:appVersion,platform:platform};logs=modifyLogs(logs,id,paramValue,reqInfo);_context16.t0=logs;if(!_context16.t0){_context16.next=11;break;}_context16.next=11;return regeneratorRuntime.awrap(logConnectNative.findAndModify("AppServiceLogs",{_id:_id},{$set:logs},void 0,{upsert:true}));case 11:logs._id=_id;return _context16.abrupt("return",logs);case 13:case"end":return _context16.stop();}}},null,_this);};var updateServiceLogs=function updateServiceLogs(logs,user,error,args,enableServiceLogs){if(!enableServiceLogs||!logs){return;}var logConnectNative=args.logConnectNative,logger=args.logger;var updateLogs={};if(user){updateLogs.user={_id:user._id,email:user.email,mobile:user.mobile};}if(error){updateLogs.status="Error";updateLogs.errorTrace=error.stack;updateLogs.errorMessage=error.message;}else{updateLogs.status="Done";}updateLogs.endTime=new Date();updateLogs.totalTime=updateLogs.endTime.getTime()-logs.startTime.getTime();if(logger){try{updateLogs.logs=JSON.stringify(logger.endLogging());}catch(err){updateLogs.logs=String(logger.endLogging());}}logConnectNative.findAndModify("AppServiceLogs",{_id:logs._id},{$set:updateLogs});};var getIp=function getIp(req){var ip=req.headers["x-real-ip"]||req.headers["remoteip"]||req.ip||req.connection.remoteAddress;return ip;};var sendErrorMail=function sendErrorMail(to,error,subject,dbConnect,params,config){var mode,mailOptions;return regeneratorRuntime.async(function sendErrorMail$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:console.log("Error in http: ",error);mode=config&&config.context&&config.context.MODE;if(mode!=="dev"){if(!to){to="rohit.bansal@daffodilsw.com";}mailOptions={to:to,from:"developer@daffodilsw.com",subject:subject,text:"Error: "+error.message+", Stack: "+error.stack+", params : "+(params?JSON.stringify(params):"")+" "};}case 3:case"end":return _context17.stop();}}},null,_this);};var modifyLogs=function modifyLogs(logs,id,paramValue,reqInfo){reqInfo=reqInfo||{};var isJSON=false;var newParamValue=paramValue;var paramRequired=id==="_authenticateUser"||id==="resetPassword"||id==="changePassword";if(!paramRequired&&typeof paramValue==="string"){try{newParamValue=JSON.parse(paramValue);isJSON=true;}catch(error){}}if(isJSONObject(newParamValue)){isJSON=true;}logs.id=id;logs.ip_address=reqInfo.ip;logs.req_origin=reqInfo.origin;logs.req_host=reqInfo.host;if(!paramRequired){logs.param=typeof newParamValue==="string"?newParamValue:JSON.stringify(newParamValue);}if(isJSON&&newParamValue._route){logs.route=newParamValue._route;}if(isJSON&&id=="_find"){logs.model=newParamValue.model;logs.query=newParamValue.query&&newParamValue.query.id;if(newParamValue.query&&newParamValue.query.relationValue){logs.relationValue=newParamValue.query.relationValue;}}else if(isJSON&&id=="_save"){logs.model=newParamValue.model;if(newParamValue.updates&&newParamValue.updates._updates){if(newParamValue.updates._updates.update){logs.op="update";logs.opId=newParamValue.updates._updates.update._id;}else if(newParamValue.updates._updates.remove){logs.op="remove";logs.opId=newParamValue.updates._updates.remove._id;}}}else if(isJSON&&id=="_batchSave"){if(newParamValue&&newParamValue.updates){var _newParamValue=newParamValue,updateValue=_newParamValue.updates;if(updateValue.length!=0&&updateValue[0]&&updateValue[0].updates&&updateValue[0].model){var _updateValue$=updateValue[0],model=_updateValue$.model,_updates=_updateValue$.updates;logs.model=model;if(_updates&&_updates.update&&_updates.update.changes){logs.op="update";logs.opId=_updates.update._id;}}}}return logs;};var parseResponseHeader=function parseResponseHeader(response){var responseInfo={};if(response&&response._headers){var _pipe=response._pipe,_data=response._data,_headers=response._headers,_download=response._download,_inline=response._inline,_fileName=response._fileName,_ignoreGzip=response._ignoreGzip,_ignoreWrap=response._ignoreWrap,_code=response._code,_cookies=response._cookies;responseInfo.data=_data;responseInfo.options={head:_extends({},_headers),code:_code,_pipe:_pipe,_cookies:_cookies};if(!_headers["Content-Disposition"]&&(_download||_inline)){responseInfo.options.head["Content-Disposition"]=(_inline?"inline":"attachment")+"; Filename=\""+(_fileName||"File")+"\"";}if(_fileName&&!_headers["Content-Type"]){responseInfo.options.head["Content-Type"]=getContentType(_fileName)||"text/plain";}responseInfo.options.ignoreGzip=_ignoreGzip!==undefined?_ignoreGzip:true;responseInfo.options.ignoreWrap=_ignoreWrap!==undefined?_ignoreWrap:true;}else{responseInfo.data=response;}return responseInfo;};var getContentType=function getContentType(fileName){var extension=fileName.split(".").pop();var extensionTypes={css:"text/css",gif:"image/gif",jpg:"image/jpeg",jpeg:"image/jpeg",js:"application/javascript",png:"image/png",mp4:"video/mp4",mp3:"audio/mpeg",txt:"text/plain",pdf:"application/pdf",xls:"application/vnd.openxmlformats",xlsx:"application/vnd.openxmlformats",html:"text/html",htm:"text/html"};if(!extension){return;}extension=extension.toLowerCase();return extensionTypes[extension];};var writeJSONResponse=function writeJSONResponse(result,req,resp){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var jsonResponseType,errorResponse,request,customHeader,responseData,gzipProperty,responseCode,gzipRequire;return regeneratorRuntime.async(function writeJSONResponse$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:jsonResponseType={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS"};if(!(result instanceof Error)){_context18.next=10;break;}errorResponse={status:"error",stack:result.stack};errorResponse.code=500;errorResponse.response={error:{message:result.message,code:result.code}};try{resp.writeHead(errorResponse.code,jsonResponseType);}catch(err){}resp.write(JSON.stringify(errorResponse));resp.end();_context18.next=24;break;case 10:if(!options._pipe){_context18.next=17;break;}request=require("request-promise");_context18.next=14;return regeneratorRuntime.awrap(request(result).pipe(resp));case 14:return _context18.abrupt("return",_context18.sent);case 17:customHeader=options.head;if(customHeader){jsonResponseType=_extends({},jsonResponseType,customHeader);}if(!options.ignoreWrap){if(result===undefined){result=null;}responseData={response:result,status:"ok",code:200};result=JSON.stringify(responseData);}gzipProperty=false;if(!options.ignoreGzip&&req.headers&&req.headers["accept-encoding"]&&req.headers["accept-encoding"].indexOf("gzip")>=0){gzipProperty=true;}responseCode=options.code||200;if(gzipProperty){gzipRequire=require("zlib");gzipRequire.gzip(result,function(err,buffer){var mergeHeader={"Content-Encoding":"gzip"};if(buffer.byteLength){mergeHeader["Content-Length"]=buffer.byteLength;}resp.writeHead(responseCode,_extends({},jsonResponseType,mergeHeader));resp.write(buffer);resp.end();});}else{resp.writeHead(responseCode,jsonResponseType);resp.write(result);resp.end();}case 24:case"end":return _context18.stop();}}},null,_this);};var getRequestParams=function getRequestParams(req,decryptRequired){var allParams={};var params=req.params||{};var body=req.body||{};var query=req.query||{};for(var key in params){if(params.hasOwnProperty(key)){allParams[key]=params[key];}}for(var key in body){if(allParams[key]===undefined){allParams[key]=body[key];}}for(var key in query){if(allParams[key]===undefined){allParams[key]=query[key];}}if(decryptRequired){allParams=(0,_Decryption.getDecryptedParams)(allParams);}return allParams;};function readFiles(req){return new Promise(function(resolve,reject){var files=[];var fields=req.query||{};var body=req.body||{};var form=new Formidable.IncomingForm();form.on("error",function(err){reject(err);});form.on("field",function(name,val){fields[name]=val;});form.onPart=function(part){if(!part.filename){form.handlePart(part);return;}var data=[];var fileName=part.filename;part.on("data",function(buffer){data.push(buffer);});part.on("end",function(){files.push({filename:fileName,data:data,name:part.name});});};form.on("end",function(){if(fields.contents){var contents=fields.contents.split(",").pop();var fileBuffer=new Buffer(contents,"base64");files.push({filename:fields.name,type:fields.type,data:[fileBuffer]});}var token=fields&&fields.token?fields.token:body&&body.token;var s3=fields&&fields.s3?fields.s3:body&&body.s3;var async=(fields&&fields.async?fields.async:body&&body.async)||false;if(s3&&typeof s3==="string"&&s3==="undefined"){s3=false;}return resolve({files:files,token:token,s3:s3,async:async});});form.parse(req);});}var getServiceByToken=function getServiceByToken(reqParams,token,mongoConnect){var result,connectionData,one_time_use,service,paramValue,returnValue;return regeneratorRuntime.async(function getServiceByToken$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:_context19.next=2;return regeneratorRuntime.awrap(mongoConnect.find("Connection",{filter:{token:token},fields:{service:1,one_time_use:1}}));case 2:result=_context19.sent;connectionData=result.result&&result.result.length&&result.result[0];one_time_use=connectionData.one_time_use,service=connectionData.service;if(one_time_use){_context19.next=7;break;}throw new Error("Token is expired.");case 7:paramValue=_extends({},reqParams);delete paramValue.token;returnValue={id:service,paramValue:paramValue};return _context19.abrupt("return",returnValue);case 11:case"end":return _context19.stop();}}},null,_this);};var authenticateUser=function authenticateUser(token,args,service){var authenticatedUserInfo,user;return regeneratorRuntime.async(function authenticateUser$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:if(token){_context20.next=2;break;}return _context20.abrupt("return");case 2:_context20.next=4;return regeneratorRuntime.awrap(args._dbConnect((0,_DBConnect.invoke)("_getAuthenticatedUser",{token:token,service:service},args)));case 4:authenticatedUserInfo=_context20.sent;user=authenticatedUserInfo&&authenticatedUserInfo.result;if(user){_context20.next=8;break;}throw new Error("Invalid token >>>>>>>>>>>>",token);case 8:return _context20.abrupt("return",user);case 9:case"end":return _context20.stop();}}},null,_this);};module.exports={configure:configure,getRequestParams:getRequestParams,parseResponseHeader:parseResponseHeader,writeJSONResponse:writeJSONResponse,getRequestInfo:getRequestInfo,authenticateUser:authenticateUser,_invoke:_invoke};