Object.defineProperty(exports,"__esModule",{value:true});exports.getRealTimeLogs=exports.typecastFilter=exports.runSubscriptions=exports.realTimeRemoveSubscribes=exports.realTimeSubscribes=undefined;var _this=this;var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _rhsCommon=require("rhs-common");var _DBConnect=require("./DBConnect");var _Http=require("./Http");function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}var isEqual=_rhsCommon.PureFunctions.isEqual,isDate=_rhsCommon.PureFunctions.isDate,deepClone=_rhsCommon.PureFunctions.deepClone,getFieldType=_rhsCommon.PureFunctions.getFieldType,isMatch=_rhsCommon.PureFunctions.isMatch,resolveValue=_rhsCommon.PureFunctions.resolveValue,isJSONObject=_rhsCommon.PureFunctions.isJSONObject,getReferenceFields=_rhsCommon.PureFunctions.getReferenceFields,getSubModels=_rhsCommon.PureFunctions.getSubModels,getRelations=_rhsCommon.PureFunctions.getRelations,getSubQueries=_rhsCommon.PureFunctions.getSubQueries,getNestedFields=_rhsCommon.PureFunctions.getNestedFields,getNullOrObject=_rhsCommon.PureFunctions.getNullOrObject;var subscriptions={};var logsRealTime={runCounter:0,sockets:0,modelwiseCounter:{},lastModel:"",lastCPUTime:0,lastDBTime:0,totalCPUTime:0,totalDBTime:0};var realTimeSubscribes=exports.realTimeSubscribes=function realTimeSubscribes(_ref){var model=_ref.model,socketId=_ref.socketId,modelId=_ref.modelId,query=_ref.query,ids=_ref.ids,uid=_ref.uid,subQueries=_ref.subQueries,token=_ref.token,globalParamValue=_ref.globalParamValue,callback=_ref.callback;subscriptions[socketId]=subscriptions[socketId]||{};if(subscriptions[socketId]&&subscriptions[socketId][modelId]){removeSubscriptions({subscriptions:subscriptions,model:model,socketId:socketId,modelId:modelId,uid:uid,metadata:query._metadata,subQueries:subQueries,token:token});}if(subQueries&&query&&query._metadata){addSubQuerySubscriptions({subscriptions:subscriptions,socketId:socketId,model:model,uid:uid,metadata:query._metadata,subQueries:subQueries,token:token,globalParamValue:globalParamValue,callback:callback});}subscriptions[socketId][modelId]=subscriptions[socketId][modelId]||[];subscriptions[socketId][modelId].push({query:query,ids:ids,uid:uid,token:token,globalParamValue:globalParamValue,callback:callback});};var realTimeRemoveSubscribes=exports.realTimeRemoveSubscribes=function realTimeRemoveSubscribes(_ref2){var model=_ref2.model,socketId=_ref2.socketId,modelId=_ref2.modelId,uid=_ref2.uid,metadata=_ref2.metadata,subQueries=_ref2.subQueries,token=_ref2.token,globalParamValue=_ref2.globalParamValue;if(subscriptions[socketId]){removeSubscriptions({subscriptions:subscriptions,model:model,socketId:socketId,modelId:modelId,uid:uid,metadata:metadata,subQueries:subQueries,token:token,globalParamValue:globalParamValue});}};var addSubQuerySubscriptions=function addSubQuerySubscriptions(_ref3){var subscriptions=_ref3.subscriptions,socketId=_ref3.socketId,model=_ref3.model,uid=_ref3.uid,metadata=_ref3.metadata,subQueries=_ref3.subQueries,token=_ref3.token,globalParamValue=_ref3.globalParamValue,callback=_ref3.callback,parent=_ref3.parent;if(!subQueries){return;}var subQueriesMetadata=metadata&&metadata._metadata;for(var field in subQueriesMetadata){var fieldType=getFieldType(model._schema,field);if(fieldType._isModel){var subQueryFieldModel=fieldType._id;var subQueryInfo=subQueriesMetadata[field];if(subQueryInfo.fieldAggregates){subscriptions[socketId][subQueryFieldModel]=subscriptions[socketId][subQueryFieldModel]||[];var subQuery={id:subQueryInfo._id};var _metadata={fieldAggregates:subQueryInfo.fieldAggregates};if(subQueryInfo._paramValue){subQuery["paramValue"]=subQueryInfo._paramValue;}_metadata["filter"]=subQueryInfo.filter||subQueryInfo.addOnFilter;if(subQueryInfo.addOnFilter){var subQueryFilter=subQuery.addOnFilter;subQuery.addOnFilter=_extends({},subQueryFilter)||{};subQuery.addOnFilter["$and"]=subQuery.addOnFilter["$and"]?[].concat(_toConsumableArray(subQuery.addOnFilter["$and"])):[];subQuery.addOnFilter["$and"].push(subQueryInfo.addOnFilter);}var _subQuery={_query:subQuery,_metadata:_metadata,_fieldAggregates:true,_subQueryField:parent?_defineProperty({},parent,field):field};subscriptions[socketId][subQueryFieldModel].push({query:_subQuery,uid:uid+"_"+field,token:token,globalParamValue:globalParamValue,callback:callback});}if(subQueryInfo._metadata){addSubQuerySubscriptions({subscriptions:subscriptions,socketId:socketId,model:fieldType,uid:uid+"_"+field,metadata:subQueryInfo,subQueries:subQueries,token:token,globalParamValue:globalParamValue,callback:callback,parent:field});}}}};var removeSubscriptions=function removeSubscriptions(_ref5){var subscriptions=_ref5.subscriptions,model=_ref5.model,socketId=_ref5.socketId,modelId=_ref5.modelId,uid=_ref5.uid,metadata=_ref5.metadata,subQueries=_ref5.subQueries,token=_ref5.token;if(subscriptions[socketId]){var subscribeModels=subscriptions[socketId];if(modelId&&uid){var modelSubscriptions=subscribeModels&&subscribeModels[modelId]||[];var index=0;for(var _iterator=modelSubscriptions,_isArray=Array.isArray(_iterator),_i=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref6;if(_isArray){if(_i>=_iterator.length)break;_ref6=_iterator[_i++];}else{_i=_iterator.next();if(_i.done)break;_ref6=_i.value;}var modelSubscribe=_ref6;var addedUID=modelSubscribe.uid;if(addedUID===uid){modelSubscriptions.splice(index,1);break;}index++;}if(subQueries&&metadata&&metadata._metadata){var subQueriesInfo=metadata._metadata;for(var field in subQueriesInfo){var fieldType=getFieldType(model._schema,field);if(fieldType._isModel){removeSubscriptions({subscriptions:subscriptions,model:fieldType,socketId:socketId,modelId:fieldType._id,uid:uid+"_"+field,token:token});}var nestedMetadata=subQueriesInfo[field]._metadata;if(nestedMetadata){for(var childField in nestedMetadata){var childFieldType=getFieldType(fieldType._schema,childField);if(childFieldType._isModel){removeSubscriptions({subscriptions:subscriptions,model:childFieldType,socketId:socketId,modelId:childFieldType._id,uid:uid+"_"+field+"_"+childField,token:token});}}}}}}else{delete subscriptions[socketId];}}};var runSubscriptions=exports.runSubscriptions=function runSubscriptions(_ref7,args){var model=_ref7.model,modelId=_ref7.modelId,changeFields=_ref7.changeFields,data=_ref7.data,old=_ref7.old,op=_ref7.op,eventSource=_ref7.eventSource,needTypeCast=_ref7.needTypeCast;var modelCount,CPUStartTime,socketId,subscribeModels,modelSubscriptions,_iterator2,_isArray2,_i2,_ref8,modelSubscribe,callback,uid,globalParamValue,ids,token,qry,fieldAggregateSubscription,query,metadata,query_required,subQueryField,group,keys,sort,nativeFilter,fields,added,removed,updated,fieldAggregates,DBStartTime,_ref9,result,aggregateValues,_aggregateValues,sortRequired,_DBStartTime,_ref10,_result,insert,groupKeyValues,index,removeId,_iterator3,_isArray3,_i3,_ref11,id,remove,_groupKeyValues,_DBStartTime2,_ref12,_result2,update,newGroupKeyValues,oldGroupKeyValues,_remove,_groupKeyValues2;return regeneratorRuntime.async(function runSubscriptions$(_context){while(1){switch(_context.prev=_context.next){case 0:logsRealTime.runCounter=logsRealTime.runCounter+1;modelCount=logsRealTime.modelwiseCounter[modelId]+1||1;logsRealTime.modelwiseCounter[modelId]=modelCount;logsRealTime.lastModel=modelId;if(!(subscriptions&&Object.keys(subscriptions).length===0)){_context.next=6;break;}return _context.abrupt("return");case 6:_context.prev=6;CPUStartTime=new Date();logsRealTime.sockets=Object.keys(subscriptions).length;_context.t0=regeneratorRuntime.keys(subscriptions);case 10:if((_context.t1=_context.t0()).done){_context.next=126;break;}socketId=_context.t1.value;subscribeModels=subscriptions[socketId];modelSubscriptions=subscribeModels&&subscribeModels[modelId]||[];_iterator2=modelSubscriptions,_isArray2=Array.isArray(_iterator2),_i2=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();case 15:if(!_isArray2){_context.next=21;break;}if(!(_i2>=_iterator2.length)){_context.next=18;break;}return _context.abrupt("break",124);case 18:_ref8=_iterator2[_i2++];_context.next=25;break;case 21:_i2=_iterator2.next();if(!_i2.done){_context.next=24;break;}return _context.abrupt("break",124);case 24:_ref8=_i2.value;case 25:modelSubscribe=_ref8;_context.prev=26;callback=modelSubscribe.callback;uid=modelSubscribe.uid;if(!(eventSource&&uid===eventSource)){_context.next=31;break;}return _context.abrupt("continue",122);case 31:globalParamValue=modelSubscribe.globalParamValue;ids=modelSubscribe.ids;token=modelSubscribe.token;qry=deepClone(modelSubscribe.query);fieldAggregateSubscription=qry._fieldAggregates;query=qry._query;metadata=qry._metadata;query_required=metadata.query_required;subQueryField=qry._subQueryField;group=query.group?query.group:metadata.group;if(!(isJSONObject(group)&&isJSONObject(group._id))){_context.next=45;break;}keys=Object.keys(group._id);if(!(keys.length>1)){_context.next=45;break;}return _context.abrupt("continue",122);case 45:sort=metadata&&metadata.sort;nativeFilter=metadata&&metadata.filter;fields=metadata&&metadata.fields;if(needTypeCast&&nativeFilter){typecastFilter(model._schema,nativeFilter);}added=needToAddRow({nativeFilter:nativeFilter,ids:ids,data:data,old:old,op:op,query_required:query_required});removed=needToRemoveRow({nativeFilter:nativeFilter,ids:ids,data:data,old:old,op:op,fieldAggregateSubscription:fieldAggregateSubscription});updated=op==="update"&&!added&&!removed?needToUpdateRow({nativeFilter:nativeFilter,ids:ids,fields:fields,changeFields:changeFields,data:data,old:old,fieldAggregateSubscription:fieldAggregateSubscription}):false;if(!fieldAggregateSubscription){_context.next=68;break;}fieldAggregates=metadata.fieldAggregates;if(!metadata.fieldAggregates){_context.next=67;break;}if(!(added||updated)){_context.next=66;break;}DBStartTime=new Date();_context.next=59;return regeneratorRuntime.awrap(getFieldData({modelId:modelId,query:query,id:data._id,token:token},_extends({},args,{globalParamValue:globalParamValue})));case 59:_ref9=_context.sent;result=_ref9.result;logsRealTime.lastDBTime=new Date()-DBStartTime;logsRealTime.totalDBTime=logsRealTime.totalDBTime+logsRealTime.lastDBTime;if(result&&Object.keys(result).length>0){aggregateValues=populateFieldAggregates({fieldAggregates:fieldAggregates,data:data,old:old,added:added,updated:updated});if(getNullOrObject(aggregateValues)){if(subQueryField){callback({aggregates:aggregateValues,uid:uid,subQueryField:subQueryField});}else{callback({aggregates:aggregateValues,uid:uid});}}}_context.next=67;break;case 66:if(removed){_aggregateValues=populateFieldAggregates({fieldAggregates:fieldAggregates,data:data,old:old,removed:removed});if(getNullOrObject(_aggregateValues)){if(subQueryField){callback({aggregates:_aggregateValues,uid:uid,subQueryField:subQueryField});}else{callback({aggregates:_aggregateValues,uid:uid});}}}case 67:return _context.abrupt("continue",122);case 68:sortRequired=isSortRequired({fields:fields,changeFields:changeFields,sort:sort,added:added,updated:updated});if(!added){_context.next=80;break;}_DBStartTime=new Date();_context.next=73;return regeneratorRuntime.awrap(getFieldData({modelId:modelId,query:query,id:data._id,token:token},_extends({},args,{globalParamValue:globalParamValue})));case 73:_ref10=_context.sent;_result=_ref10.result;logsRealTime.lastDBTime=new Date()-_DBStartTime;logsRealTime.totalDBTime=logsRealTime.totalDBTime+logsRealTime.lastDBTime;if(_result&&Object.keys(_result).length>0){insert={insert:_result,uid:uid};if(sortRequired){insert["sort"]=sort;}if(group){groupKeyValues=getGroupFieldValue(model,group._id,_result);insert["groupKeyValues"]={};insert["groupKeyValues"]["new"]=groupKeyValues;}callback(insert);}_context.next=117;break;case 80:if(!removed){_context.next=108;break;}index=0;removeId=void 0;_iterator3=ids,_isArray3=Array.isArray(_iterator3),_i3=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();case 84:if(!_isArray3){_context.next=90;break;}if(!(_i3>=_iterator3.length)){_context.next=87;break;}return _context.abrupt("break",103);case 87:_ref11=_iterator3[_i3++];_context.next=94;break;case 90:_i3=_iterator3.next();if(!_i3.done){_context.next=93;break;}return _context.abrupt("break",103);case 93:_ref11=_i3.value;case 94:id=_ref11;if(!isEqual(data,id)){_context.next=100;break;}removeId={};removeId["_id"]=id;ids.splice(index,1);return _context.abrupt("break",103);case 100:index++;case 101:_context.next=84;break;case 103:remove={remove:removeId,uid:uid};if(group){_groupKeyValues=getGroupFieldValue(model,group._id,old);remove["groupKeyValues"]={};remove["groupKeyValues"]["old"]=_groupKeyValues;}callback(remove);_context.next=117;break;case 108:if(!updated){_context.next=117;break;}_DBStartTime2=new Date();_context.next=112;return regeneratorRuntime.awrap(getFieldData({modelId:modelId,query:query,id:data._id,token:token},_extends({},args,{globalParamValue:globalParamValue})));case 112:_ref12=_context.sent;_result2=_ref12.result;logsRealTime.lastDBTime=new Date()-_DBStartTime2;logsRealTime.totalDBTime=logsRealTime.totalDBTime+logsRealTime.lastDBTime;if(_result2&&Object.keys(_result2).length>0){update={update:_result2,uid:uid};if(sortRequired){update["sort"]=sort;}if(group){newGroupKeyValues=getGroupFieldValue(model,group._id,_result2);oldGroupKeyValues=getGroupFieldValue(model,group._id,old);update["groupKeyValues"]={};update["groupKeyValues"]["new"]=newGroupKeyValues;update["groupKeyValues"]["old"]=oldGroupKeyValues;}callback(update);}else{_remove={remove:{_id:data._id},uid:uid};if(group){_groupKeyValues2=getGroupFieldValue(model,group._id,old);_remove["groupKeyValues"]={};_remove["groupKeyValues"]["old"]=_groupKeyValues2;}callback(_remove);}case 117:_context.next=122;break;case 119:_context.prev=119;_context.t2=_context["catch"](26);console.log("Error coming in real time sync. Error:",_context.t2);case 122:_context.next=15;break;case 124:_context.next=10;break;case 126:logsRealTime.lastCPUTime=new Date()-CPUStartTime;logsRealTime.totalCPUTime=logsRealTime.totalCPUTime+logsRealTime.lastCPUTime;return _context.abrupt("return");case 131:_context.prev=131;_context.t3=_context["catch"](6);throw new Error(_context.t3);case 134:case"end":return _context.stop();}}},null,_this,[[6,131],[26,119]]);};var typecastFilter=exports.typecastFilter=function typecastFilter(schema,filterValue){if(isJSONObject(filterValue)){for(var key in filterValue){var f=key.split(".")[0];var value=filterValue[key];if(key==="$and"||key==="$or"){if(Array.isArray(value)){for(var _iterator4=value,_isArray4=Array.isArray(_iterator4),_i4=0,_iterator4=_isArray4?_iterator4:_iterator4[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref13;if(_isArray4){if(_i4>=_iterator4.length)break;_ref13=_iterator4[_i4++];}else{_i4=_iterator4.next();if(_i4.done)break;_ref13=_i4.value;}var val=_ref13;if(isJSONObject(val)){typecastFilter(schema,val);}}}else{throw new Error("Invalid value ["+JSON.stringify(value)+"] of key ["+key+"] in type cast filter. The value type should be an array.");}}else if(key.startsWith("$")){continue;}else if(schema[f]){filterValue[key]=convertValue(schema,f,value);}else{throw new Error("Field ["+f+"] not found with key ["+key+"] and value ["+JSON.stringify(value)+"] in type cast filter.");}}}else{throw new Error("Invalid filter ["+JSON.stringify(filterValue)+"] in type cast filter.");}};var convertValue=function convertValue(schema,field,value){var fieldInfo=getFieldType(schema,field);if(fieldInfo===_rhsCommon.Primitive.date||fieldInfo._isModel){var convertedValue=void 0;try{if(Array.isArray(value)){convertedValue=[];for(var _iterator5=value,_isArray5=Array.isArray(_iterator5),_i5=0,_iterator5=_isArray5?_iterator5:_iterator5[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref14;if(_isArray5){if(_i5>=_iterator5.length)break;_ref14=_iterator5[_i5++];}else{_i5=_iterator5.next();if(_i5.done)break;_ref14=_i5.value;}var v=_ref14;if(fieldInfo===_rhsCommon.Primitive.date){if(!isDate(v)){v=new Date(v);convertedValue.push(v);}}else if(fieldInfo._isModel){convertedValue.push((0,_DBConnect.getObjectId)(v));}}}else if(isJSONObject(value)){convertedValue={};for(var key in value){var _v=value[key];if(key==="$in"||key==="$nin"){var convertedVls=[];for(var _iterator6=_v,_isArray6=Array.isArray(_iterator6),_i6=0,_iterator6=_isArray6?_iterator6:_iterator6[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref15;if(_isArray6){if(_i6>=_iterator6.length)break;_ref15=_iterator6[_i6++];}else{_i6=_iterator6.next();if(_i6.done)break;_ref15=_i6.value;}var vl=_ref15;if(fieldInfo===_rhsCommon.Primitive.date){if(!isDate(vl)){vl=new Date(vl);convertedVls.push(vl);}}else if(fieldInfo._isModel){convertedVls.push((0,_DBConnect.getObjectId)(vl));}else{convertedVls.push(vl);}}convertedValue[key]=convertedVls;}else if(key==="$exists"){convertedValue[key]=_v;}else{if(fieldInfo===_rhsCommon.Primitive.date){if(!isDate(_v)){_v=new Date(_v);convertedValue[key]=_v;}}else if(fieldInfo._isModel){convertedValue[key]=(0,_DBConnect.getObjectId)(_v);}}}}else{if(fieldInfo===_rhsCommon.Primitive.date){if(!isDate(value)){convertedValue=new Date(value);}}else if(fieldInfo._isModel){convertedValue=(0,_DBConnect.getObjectId)(value);}}}catch(err){console.log("Invalid value Field :["+field+"] and Value :["+JSON.stringify(value)+"] in type case filter.");convertedValue=value;}return convertedValue;}else{return value;}};var getFieldData=function getFieldData(_ref16,args){var modelId=_ref16.modelId,query=_ref16.query,id=_ref16.id,token=_ref16.token;var user,_args2,_dbConnect;return regeneratorRuntime.async(function getFieldData$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:query.addOnFilter=_extends({},query.addOnFilter)||{};query.addOnFilter["$and"]=query.addOnFilter["$and"]?[].concat(_toConsumableArray(query.addOnFilter["$and"])):[];query.addOnFilter["$and"].push({_id:id});query.only=true;query.skip=0;query.limit=1;query.fieldAggregates=null;query.metadata=false;query.skipData=false;_context2.prev=9;_context2.next=12;return regeneratorRuntime.awrap((0,_Http.authenticateUser)(token,args));case 12:user=_context2.sent;args=_extends({},args,{user:user});_args2=args,_dbConnect=_args2._dbConnect;_context2.next=17;return regeneratorRuntime.awrap(_dbConnect((0,_DBConnect.invoke)("_find",{model:modelId,query:query},args)));case 17:return _context2.abrupt("return",_context2.sent);case 20:_context2.prev=20;_context2.t0=_context2["catch"](9);console.log("Error coming in real time sync getFieldData query. Error:",_context2.t0);return _context2.abrupt("return",{result:[]});case 24:case"end":return _context2.stop();}}},null,_this,[[9,20]]);};var needToAddRow=function needToAddRow(_ref17){var nativeFilter=_ref17.nativeFilter,ids=_ref17.ids,data=_ref17.data,old=_ref17.old,op=_ref17.op,query_required=_ref17.query_required;if(op==="insert"){return query_required?true:isMatch(data,nativeFilter);}else if(nativeFilter&&op==="update"){var updateMatched=isMatch(data,nativeFilter);var oldMatched=isMatch(old,nativeFilter);if(updateMatched&&!oldMatched){return true;}}return false;};var needToRemoveRow=function needToRemoveRow(_ref18){var nativeFilter=_ref18.nativeFilter,ids=_ref18.ids,data=_ref18.data,old=_ref18.old,op=_ref18.op,fieldAggregateSubscription=_ref18.fieldAggregateSubscription;if(nativeFilter){var updateMatched=op==="update"?isMatch(data,nativeFilter):false;var oldMatched=isMatch(old,nativeFilter);if(!updateMatched&&oldMatched){if(fieldAggregateSubscription){return true;}else if(ids){for(var _iterator7=ids,_isArray7=Array.isArray(_iterator7),_i7=0,_iterator7=_isArray7?_iterator7:_iterator7[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref19;if(_isArray7){if(_i7>=_iterator7.length)break;_ref19=_iterator7[_i7++];}else{_i7=_iterator7.next();if(_i7.done)break;_ref19=_i7.value;}var id=_ref19;if(isEqual(data,id)){return true;}}}}}else if(op==="remove"){if(fieldAggregateSubscription){return true;}else if(ids){for(var _iterator8=ids,_isArray8=Array.isArray(_iterator8),_i8=0,_iterator8=_isArray8?_iterator8:_iterator8[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref20;if(_isArray8){if(_i8>=_iterator8.length)break;_ref20=_iterator8[_i8++];}else{_i8=_iterator8.next();if(_i8.done)break;_ref20=_i8.value;}var _id=_ref20;if(isEqual(data,_id)){return true;}}}}return false;};var needToUpdateRow=function needToUpdateRow(_ref21){var nativeFilter=_ref21.nativeFilter,ids=_ref21.ids,fields=_ref21.fields,changeFields=_ref21.changeFields,data=_ref21.data,old=_ref21.old,fieldAggregateSubscription=_ref21.fieldAggregateSubscription;if(nativeFilter){var updateMatched=isMatch(data,nativeFilter);var oldMatched=isMatch(old,nativeFilter);if(updateMatched&&oldMatched){if(fieldAggregateSubscription){return true;}else if(ids){for(var _iterator9=ids,_isArray9=Array.isArray(_iterator9),_i9=0,_iterator9=_isArray9?_iterator9:_iterator9[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref22;if(_isArray9){if(_i9>=_iterator9.length)break;_ref22=_iterator9[_i9++];}else{_i9=_iterator9.next();if(_i9.done)break;_ref22=_i9.value;}var id=_ref22;if(isEqual(data,id)){return true;}}}}}else if(fieldAggregateSubscription){return true;}if(fields&&ids){var matchedId=void 0;for(var _iterator10=ids,_isArray10=Array.isArray(_iterator10),_i10=0,_iterator10=_isArray10?_iterator10:_iterator10[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref23;if(_isArray10){if(_i10>=_iterator10.length)break;_ref23=_iterator10[_i10++];}else{_i10=_iterator10.next();if(_i10.done)break;_ref23=_i10.value;}var _id2=_ref23;if(isEqual(data,_id2)){matchedId=_id2;break;}}if(matchedId){for(var field in fields){if(changeFields&&changeFields[field]){return true;}}}}return false;};var isSortRequired=function isSortRequired(_ref24){var fields=_ref24.fields,changeFields=_ref24.changeFields,sort=_ref24.sort,added=_ref24.added,updated=_ref24.updated;var required=added?true:false;if(!added&&updated){for(var field in fields){if(changeFields&&changeFields[field]){if(field==="_id"&&sort[field]===-1){required=true;break;}else{required=true;break;}}}}return required;};var populateFieldAggregates=function populateFieldAggregates(_ref25){var fieldAggregates=_ref25.fieldAggregates,data=_ref25.data,old=_ref25.old,added=_ref25.added,updated=_ref25.updated,removed=_ref25.removed;var aggregates={};for(var field in fieldAggregates){if(field==="_first"){continue;}if(added){if(field==="_count"){aggregates[field]=1;}else{var value=resolveValue(data,field)||0;if(value!==0){aggregates[field]=value;}}}else if(updated&&field!=="_count"){var updatedValue=resolveValue(data,field)||0;var oldValue=resolveValue(old,field)||0;var difference=updatedValue-oldValue;if(difference!==0){aggregates[field]=difference;}}else if(removed){if(field==="_count"){aggregates[field]=-1;}else{var _oldValue=resolveValue(old,field)||0;if(_oldValue!==0){aggregates[field]=0-_oldValue;}}}}if(Object.keys(aggregates).length>0){return aggregates;}return;};var getGroupFieldValue=function getGroupFieldValue(model,group,data){var relations=getRelations(model);var subQueries=getSubQueries(model);var subModels=getSubModels(model._schema);var nestedFields=getNestedFields(relations,subModels,subQueries);var references=getReferenceFields(model._schema,nestedFields);var groupKeyValues={};for(var groupField in group){var groupValue=data[groupField];var groupKey=groupField;if(isJSONObject(groupValue)&&references&&references[groupField]){groupValue=groupValue["_id"];groupKey=groupKey+"._id";}else if(Array.isArray(groupValue)&&groupValue.length>0&&(references&&references[groupField]||nestedFields&&nestedFields[groupField])){groupValue=groupValue[0]["_id"];groupKey=groupKey+"._id";}groupKeyValues[groupKey]=groupValue;}return groupKeyValues;};var getRealTimeLogs=exports.getRealTimeLogs=function getRealTimeLogs(){function memorySizeOf(obj){var bytes=0;function sizeOf(obj){if(obj!==null&&obj!==undefined){switch(typeof obj){case"number":bytes+=8;break;case"string":bytes+=obj.length*2;break;case"boolean":bytes+=4;break;case"object":var objClass=Object.prototype.toString.call(obj).slice(8,-1);if(objClass==="Object"||objClass==="Array"){for(var key in obj){if(!obj.hasOwnProperty(key))continue;sizeOf(obj[key]);}}else bytes+=obj.toString().length*2;break;}}return bytes;}var formatByteSize=function formatByteSize(bytes){if(bytes<1024)return bytes+" Bytes";else if(bytes<1048576)return(bytes/1024).toFixed(3)+" KB";else if(bytes<1073741824)return(bytes/1048576).toFixed(3)+" MB";else return(bytes/1073741824).toFixed(3)+" GB";};return formatByteSize(sizeOf(obj));}var formatTime=function formatTime(time){if(time<1000)return time+" ms";else if(time<60000)return(time/1000).toFixed(3)+" sec";else if(time<3600000)return(time/60000).toFixed(3)+" min";else return(time/3600000).toFixed(3)+" hr";};logsRealTime.totalQueryTime=formatTime(logsRealTime.totalDBTime);logsRealTime.totalProcessTime=formatTime(logsRealTime.totalCPUTime);logsRealTime.lastQueryTime=formatTime(logsRealTime.lastDBTime);logsRealTime.lastProcssTime=formatTime(logsRealTime.lastCPUTime);var subscribeSize=memorySizeOf(subscriptions);return _extends({subscribeSize:subscribeSize},logsRealTime);};